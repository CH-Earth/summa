
1. First install BMI. Download the latest release of BMI from https://github.com/csdms/bmi-fortran.git
% git clone https://github.com/csdms/bmi-fortran.git

2. Make a directory outside the bmi-fortran folder and enter it, and make the install and build dirs, enter the build dir.
% export BMIF_VERSION=2.0
% mkdir bmi
% cd bmi
% mkdir instdir
% mkdir buildir
% cd /buildir
NOTE if you need to recompile after a system upgrade, delete the contents of these directories before running cmake in the next step!

3. Since in SUMMA-SUNDIALS utilizes the Fortran/C interface FIDA, the following setting needs to be enabled while running the cmake inside the builddir, using your home directory as $(YOUR_HOME)
% cmake ../../bmi-fortran/ -DCMAKE_INSTALL_PREFIX=$(YOUR_HOME)/bmi/instdir 

-DCMAKE_BUILD_WITH_INSTALL_RPATH=ON -DCMAKE_INSTALL_RPATH=/Users/amedin/Research/SummaSundials/bmi/instdir/lib -DCMAKE_SKIP_BUILD_RPATH=OFF -DCMAKE_BUILD_RPATH=/Users/amedin/Research/SummaSundials/bmi/instdir/lib


INSTALL_RPATH to a specific folder and set BUILD_WITH_INSTALL_RPATH to TRUE
You can do this by running from inside buildir, where the star is the system specific file with hardcoded paths:
cp ../../summa/build/build_cmakeBMI_* build_cmake
./build_cmake

4. The default compiler is gfortan. To change it (it should be the same as the netcdf build and the later summa build), you could also add the following option to cmake with your $(YOUR_GFORTRAN)
   -DCMAKE_Fortran_COMPILER=$(YOUR_GFORTRAN)

5. If the above went well, staying in the buildir directory run

#!/usr/bin/env bash
# Updates runtime paths for executables on macOS.
install_name_tool -change @rpath/libbmif.2.0.dylib $(YOUR_HOME)/bmi/instdir/lib/libbmif.2.0.dylib

% make
% make install

6. If you are using Sundials, now install that. Download the latest release of IDA solver from SUNDIALS package in https://computing.llnl.gov/projects/sundials/sundials-software
% wget "https://github.com/LLNL/sundials/releases/download/v6.3.0/sundials-6.3.0.tar.gz"

7. Extract the corresponding compressed file
% tar -xzf sundials-6.3.0.tar.gz

8. Read INSTALL_GUIDE.pdf and follow the installation instructions. Roughly, do the following:
Make a directory outside the sundials-6.3.0 folder and enter it, and make the install and build dirs, enter the build dir.
% mkdir sundials
% cd sundials
% mkdir instdir
% mkdir buildir
% cd /buildir
NOTE if you need to recompile after a system upgrade, delete the contents of these directories before running cmake in the next step!

9. Since in SUMMA-SUNDIALS utilizes the Fortran/C interface FIDA, the following setting needs to be enabled while running the cmake inside the builddir, using your home directory as $(YOUR_HOME)
% cmake ../sundials-5.8.0/ -DBUILD_FORTRAN_MODULE_INTERFACE=ON DCMAKE_INSTALL_PREFIX=$(YOUR_HOME)/sundials/instdir -DEXAMPLES_INSTALL_PATH=$(YOUR_HOME)/sundials/instdir/examples
You can do this by running from inside buildir, where the star is the system specific file with hardcoded paths:
cp ../../summa/build/build_cmakeSundials_* build_cmake
./build_cmake

10. The default compiler is gfortan. To change it (it should be the same as the netcdf build and the later summa build), you could also add the following option to cmake with your $(YOUR_GFORTRAN)
   -DCMAKE_Fortran_COMPILER=$(YOUR_GFORTRAN)

11. If the above went well, staying in the buildir directory run
% make
% make install

12. Enter summa directory and build summa as in /docs/SUMMA_installation.md. You will have to edit the SUMMA Makefile as below additionally (as well as install required libraries and link them as directed in the Makefile). You need to clone summa before you can change the makefile
	git clone https://git.cs.usask.ca/numerical_simulations_lab/summa.git

13. In SUMMA Makefile, define the FC_EXE to be the same compiler as you used for BMI and netcdf
   
14. In SUMMA Makefile, define the SUNDIALS installation directory (and all the folders as required in the SUMMA instructions.
	DIR_SUNDIALS=$(YOUR_HOME)/sundials/instdir

15. Inside the /summa/build/ directory run
% make
or % source build_summa_* if you are using a specific * compiler

16. On linux installations you may need to add to your .bashrc file (and run source $(YOUR_HOME)/.bashrc)
export LD_LIBRARY_PATH=$(YOUR_HOME)/sundials/instdir/lib64
export LD_LIBRARY_PATH=$(YOUR_HOME)/bmi/instdir/lib64

This does not work on macOS, sundials libraries should be found as complied but the BMI libraries will need to use the Xlinker commands
LIB_BMI=-L$(DIR_BMI)/lib -lbmif -Xlinker -rpath -Xlinker $(DIR_BMI)/lib


